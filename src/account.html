<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/styles.css" />
    <title>Document</title>
  </head>
  <body>
    <header>
      <h1 id="name"></h1>
      <a class="btn" href="/logout">Logga ut</a>
    </header>
    <main id="root">
      <div id="user-urls"></div>
    </main>

    <form>
      <label for="longUrl">longUrl</label>
      <input type="text" id="longUrl" placeholder="www.google.com">
      <button type="submit" id="saveButton" name="saveUrl">Save Url</button>
    </form>


  </body>
  <script>
    (async function () {
      const response = await fetch("/.auth/me");
      const data = await response.json();

      let heading = document.querySelector("#name");
      heading.innerText = data.clientPrincipal.userDetails;
    })();

    getStats();

    async function getStats() {
      let nameResponse = await fetch("/.auth/me");
      let name = await nameResponse.json();

      let response = await fetch(
        `/api/getUrlStats?userName=${name.clientPrincipal.userDetails}`
      );
      if (response.status === 200) {
        let data = await response.json();
        displayStats(await data);
      } else if (response.status === 404) {
        let root = document.querySelector("#user-urls");
        root.innerHTML = "";
        let heading = document.createElement("h2");
        heading.textContent = "Inga URL:er att visa";
        root.appendChild(heading);
      }
    }

    function displayStats(data) {
      let root = document.querySelector("#user-urls");
      root.innerHTML = "";
      let heading = document.createElement("h2");
      heading.classList.add = "user-urls-heading";
      heading.textContent = "Dina Skapade URL:er";
      root.appendChild(heading);

      let urls = document.createElement("div");

      for (let i = 0; i < data.length; i++) {
        let statText = document.createElement("p");
        statText.textContent = `Id: ${data[i].id}, Url: ${data[i].longUrl}, Skapades: ${data[i].createdAt}, Antal klick: ${data[i].timesClicked}`;
        urls.appendChild(statText);
      }

      root.appendChild(urls);
    }

        document.getElementById("saveButton").addEventListener("click", async function(e){
          e.preventDefault();
          console.log("Du kom in i din funktion, bitch");
          let nameResponse = await fetch("/.auth/me");
          let name = await nameResponse.json();
        
          let longUrl = getElementById("longUrl").value;
          const partialTableData = { LongUrl: longUrl,
                         CreatedBy: name.clientPrincipal.userDetails};
          const response = await fetch('/api/SaveUrl', {
            method: 'POST',
            body: JSON.stringify(partialTableData)
          });
          const responseText = await response.text();
          console.log(responseText); // logs 'OK'

        
      });


  
  </script>
</html>
